<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>World@war pré-alpha</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<canvas id="myCanvas"></canvas>
<script src="js/three.js"></script>

<script>
    var socket = io();

    var WIDTH = window.innerWidth,
        HEIGHT = window.innerHeight-4,
        VIEW_ANGLE = 45,
        ASPECT = WIDTH / HEIGHT,
        NEAR = 0.1,
        FAR = 10000,
        DISTANCIA_MAX = 1000;
    var scene, renderer, camera, cloudMesh, earthMesh, controls, text2, material, bolCityLightsON=false;
    var lblPlayersCount, playerLoggedIn = false, serverDateTime, globalPlayersList = {}, playersMesh ;

    init();
    animate();

    /**
     * Metodo que inicia a cena
     */
    function init(){
        //SCENE
        scene = new THREE.Scene();

        //CAMERA
        camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
        camera.position.set(0, 100, DISTANCIA_MAX);
        camera.lookAt(scene.position);

        //RENDERER
        renderer = new THREE.WebGLRenderer({canvas: document.getElementById('myCanvas'), antialias: true});
        renderer.setClearColor(0x000000);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(WIDTH, HEIGHT);
        document.body.appendChild(renderer.domElement);

        //LIGHTS
        var light = new THREE.AmbientLight(0xffffff, 1.0);
        scene.add(light);

        createEarth();

        createEarthClouds();

        createSkyBox();

        window.addEventListener( 'resize', onWindowResize, false );

        text2 = document.createElement('div');
        text2.style.position = 'absolute';
        //text2.style.zIndex = 1;
        text2.style.width = 100;
        text2.style.height = 100;
        text2.style.backgroundColor = "blue";
        text2.innerHTML = "yoooo!";
        text2.style.top = 40 + 'px';
        text2.style.left = 800 + 'px';

        createLabel("playerCount","playerCount","World@War Server Player's: ",10,20,null);
        createLabel("serverDateTime","serverDateTime","Server Date/Time: ",10,250,null);

        lblPlayersCount = document.createElement('div');
        createLabel("serverPlayersCount","serverPlayersCount","0",10,220,lblPlayersCount);

        serverDateTime = document.createElement('div');
        createLabel("serverDateTime","serverDateTime","- nenhum -",10,380,serverDateTime);

        createButton("btlogin","Login",50,50,function () {
            var txtbox = document.getElementById('loginName');
            var intLocal = document.getElementById('country').value;

            if (txtbox.value.length > 0) {
                var value = txtbox.value;

                socket.emit("newPlayer", {
                    name: value,
                    local: intLocal
                });

                socket.on("newPlayerResponse", function (data) {
                    playerLoggedIn = data.login;
                    lblPlayersCount.innerHTML = data.playerCount;

                    if (playerLoggedIn) {
                        var child = document.getElementById("btlogin");
                        child.parentNode.removeChild(child);
                        var child = document.getElementById("loginName");
                        child.parentNode.removeChild(child);
                        var child = document.getElementById("country");
                        child.parentNode.removeChild(child);

                        var playerLocal;
                        switch (data.local) {
                            case '1':
                                playerLocal = "EU - Europe";
                                break;
                            case '2':
                                playerLocal = "AF - Africa";
                                break;
                            case '3':
                                playerLocal = "AU - Australia";
                                break;
                        }

                        createLabel("playerStatus", "playerStatus", data.name + " is logged in " + playerLocal, 80, 20, null);
                    }

                });

                socket.on("playersList", function (data) {
                    createPlayerPositions(data);
                });
            }
        });

        createInputField('loginName',50,100);

        createComboBox("country",50,280);

        text3 = document.createElement('div');
        text3.style.position = 'absolute';
        //text2.style.zIndex = 1;
        text3.style.width = 100;
        text3.style.height = 100;
        text3.style.backgroundColor = "transparent";
        text3.style.color ="red";
        text3.innerHTML = "OFF";
        text3.style.top = 12 + 'px';
        text3.style.left = 880 + 'px';

        createButton("CityLights","City Lights",10,800,function() {

            if (bolCityLightsON){
                earthMesh.material.map = THREE.ImageUtils.loadTexture('images/earthlights1k.jpg');
                text3.style.color ="lightgreen";
                text3.innerHTML = "ON";
            } else {
                earthMesh.material.map = THREE.ImageUtils.loadTexture('images/earthmap4k.jpg');
                text3.style.color ="red";
                text3.innerHTML = "OFF";
            }

            bolCityLightsON = !bolCityLightsON;

            //cloudMesh.material.needsUpdate = true;
            earthMesh.material.needsUpdate = true;

        });

        document.body.appendChild(text2);
        document.body.appendChild(text3);

    }

    /**
     * Metodo que é chamada a cada frame
     */
    function animate() {
        requestAnimationFrame(animate);

        if (text2.textContent)
            text2.textContent = earthMesh.rotation.y;
        else if (text2.innerText)
            text2.innerText = earthMesh.rotation.y;
        else
            text2.innerHTML = earthMesh.rotation.y;

        earthMesh.rotation.y = Date.now() * -0.00001;
        cloudMesh.rotation.y = Date.now() * -0.00001;

        if (playerLoggedIn){
            /*var el = document.getElementById('btlogin');
             el.parentNode.removeChild(el);
             var el1 = document.getElementById('loginName');
             el1.parentNode.removeChild(el1);
             */
            //var elem = document.getElementById("btlogin");
            //elem.remove();
            //elem.visible = false;

        }

        render();
    }

    function createEarth() {
        var geometry = new THREE.SphereGeometry(175,32,32);

        //var material = new THREE.MeshLambertMaterial({color: 0xF3FFE2});
        material = new THREE.MeshPhongMaterial();
        material.map = THREE.ImageUtils.loadTexture('images/earthmap4k.jpg');            // Diffuse Texture
        material.bumpMap = THREE.ImageUtils.loadTexture('images/earthbump4k.jpg');       // Bump Texture
        material.bumpScale = 0.05;
        material.specularMap = THREE.ImageUtils.loadTexture('images/earthspec4k.jpg');   // Spectacular Texture
        material.specular = new THREE.Color('grey');
        earthMesh = new THREE.Mesh(geometry, material);
        scene.add(earthMesh);
    }

    function createEarthClouds() {
        var geometry1   = new THREE.SphereGeometry(177, 32, 32);
        var material1  = new THREE.MeshPhongMaterial({
            map         : new THREE.ImageUtils.loadTexture('images/earthcloudmap2.jpg'),
            side        : THREE.DoubleSide,
            opacity     : 0.3,
            transparent : true,
            depthWrite  : false
        });
        cloudMesh = new THREE.Mesh(geometry1, material1);
        earthMesh.add(cloudMesh);
    }

    function createSkyBox() {
        // SKYBOX
        var geometry2  = new THREE.SphereGeometry(1000, 32, 32);
        var material2  = new THREE.MeshBasicMaterial({
            map   : new THREE.ImageUtils.loadTexture('images/skybox1.jpg'),
            side  : THREE.BackSide
        });
        var skyBoxMesh  = new THREE.Mesh(geometry2, material2); // cria mesh com geometria e material
        scene.add(skyBoxMesh);
    }

    function createPlayerPositions(playersList) {
        var geom = new THREE.Geometry();
        //var geom = new THREE.SphereGeometry(180,32,32);
        //var cubeMat = new THREE.MeshLambertMaterial({color: 0x000000,opacity:0.6, emissive:0xffffff});
        var cubeMat = new THREE.MeshLambertMaterial({color: "red",opacity:0.6});

        for (var i= 0; i < playersList.length; i++){
            var d = playersList[i].local.split("#");

            var position = latLongToVector3(d[0], d[1], 175);

            // create the cube
            var cube = new THREE.Mesh(new THREE.CubeGeometry(5,5,1+300/8,1,1,1,cubeMat));

            // position the cube correctly
            cube.position.set(position.x,position.y,position.z);
            cube.lookAt( new THREE.Vector3(0,0,0) );

            // merge with main model
            THREE.GeometryUtils.merge(geom,cube);

        }

        //var total = new THREE.Mesh(geom,new THREE.MeshFaceMaterial());
        playersMesh = new THREE.Mesh(geom,cubeMat);
        playersMesh.name = 'playersMesh';

        earthMesh.add(playersMesh);
    }

    /**
     * Metodo que efetua o render da scene e camera
     */
    function render() {
        renderer.render(scene, camera);
    }

    /**
     * Metodo que controla o redimensionamento da janela do browser
     */
    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );
        render();
    }

    function createLabel(id, name, text, x, y, object){
        var label;

        if(object==null){
            label = document.createElement('div');
        } else {
            label=object;
        }

        //label = document.createElement('div');
        label.style.position = 'absolute';
        label.name = name;
        label.id = id;
        label.style.width = 100;
        label.style.height = 100;
        label.style.backgroundColor = "transparent";
        label.style.color ="white";
        label.innerHTML = text;
        label.style.top = x + 'px';
        label.style.left = y + 'px';

        document.body.appendChild(label);
    }

    function createInputField(id, x, y) {
        var field = document.createElement("INPUT");
        field.setAttribute("type", "text");
        field.style.position = 'absolute';
        field.style.top = x + 'px';
        field.style.left = y + 'px';
        field.id = id;

        document.body.appendChild(field);
    }

    function createComboBox(id, x, y) {
        var combo_box = document.createElement('select');
        combo_box.name = id;
        combo_box.id = id;
        combo_box.style.position = 'absolute';
        combo_box.style.top = x + 'px';
        combo_box.style.left = y + 'px';

        var choice = document.createElement('option');
        choice.value = '1';
        choice.appendChild(document.createTextNode('EU - Europe'));
        combo_box.appendChild(choice);

        choice = document.createElement('option');
        choice.value = '2';
        choice.appendChild(document.createTextNode('AF - Africa'));
        combo_box.appendChild(choice);

        choice = document.createElement('option');
        choice.value = '3';
        choice.appendChild(document.createTextNode('AU - Australia'));

        combo_box.appendChild(choice);
        document.body.appendChild(combo_box);
    }

    function createButton(id, title, x, y, data) {
        var btn = document.createElement("button");
        var t = document.createTextNode(title);
        btn.appendChild(t);
        btn.id = id;
        btn.style.position = 'absolute';
        btn.style.top = x + 'px';
        btn.style.left = y + 'px';
        btn.onclick = data;

        document.body.appendChild(btn);
    }

    /**
     * Metodo que converte posicoes latitude e longitude para posicoes em um esfera
     */
    function latLongToVector3(lat, lon, radius) {
       // var phi = (lat)*Math.PI/180;
       // var theta = (lon-180)*Math.PI/180;
     /*
        var x = -(radius+heigth) * Math.cos(phi) * Math.cos(theta);
        var y = (radius+heigth) * Math.sin(phi);
        var z = (radius+heigth) * Math.cos(phi) * Math.sin(theta);*/

        var phi   = (90-lat)*(Math.PI/180);
        var theta = (lon+180)*(Math.PI/180);
        var x = -((radius ) * Math.sin(phi)*Math.cos(theta));
        var z = ((radius ) * Math.sin(phi)*Math.sin(theta));
        var y = ((radius ) * Math.cos(phi));

        return new THREE.Vector3(x,y,z);
    }

    socket.on("serverStatus", function (data) {
        lblPlayersCount.innerHTML = data.playerCount;
        serverDateTime.innerHTML = data.timestamp;
        //console.log(data.total);
    });

    socket.on("playersList", function (data) {
        //var t = scene.getObjectByName('playersMesh');
        //scene.remove(t);
        earthMesh.remove(playersMesh);
        console.log("aqui");
        //createPlayerPositions(data);
    });

</script>
</body>
</html>